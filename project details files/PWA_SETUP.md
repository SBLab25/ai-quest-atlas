# PWA Setup Documentation

## Overview
Discovery Atlas has been converted into a Progressive Web App (PWA) with offline capabilities, installability, and background sync features.

## Features Implemented

### 1. Service Worker & Caching
- **Plugin**: Using `vite-plugin-pwa` with Workbox
- **Cache Strategy**:
  - Static assets: Cache-first strategy
  - Supabase API calls: Network-first strategy (24h cache)
  - Map tiles (Geoapify): Cache-first strategy (30 days)
  - Images: Cache-first strategy (30 days)

### 2. Web App Manifest
- **App Name**: Discovery Atlas
- **Short Name**: Discovery
- **Theme Color**: #10b981 (emerald green)
- **Background Color**: #0a0a0a (dark)
- **Display**: Standalone (full-screen app experience)
- **Icons**: 192x192 and 512x512 PNG icons

### 3. Offline Functionality
- **IndexedDB Storage**: Using `idb` library
- **Cached Data**:
  - Quest details for offline viewing
  - User profile information
  - Previously viewed content
- **Submission Queue**: Pending submissions stored locally and synced when online
- **Automatic Cache Cleanup**: Removes data older than 7 days

### 4. Install Prompt
Component: `src/components/pwa/InstallPrompt.tsx`
- Detects if app is installable
- Shows custom install prompt (instead of browser default)
- Appears on second visit or after 30 seconds
- Can be dismissed (won't show again for 7 days)
- Tracks installation state

### 5. Update Notification
Component: `src/components/pwa/UpdateNotification.tsx`
- Detects when new version is available
- Shows "Update available" notification
- One-click update and reload

### 6. Offline Indicator
Component: `src/components/pwa/OfflineIndicator.tsx`
- Shows when user goes offline
- Shows "Back online!" message when reconnected
- Auto-dismisses after 3 seconds when online

### 7. Offline Fallback Page
Route: `/offline`
Component: `src/pages/Offline.tsx`
- Friendly "You're offline" message
- Shows count of cached quests available
- Tips for reconnecting
- Links to home and refresh

## File Structure

```
src/
├── components/
│   └── pwa/
│       ├── InstallPrompt.tsx       # Custom install prompt
│       ├── OfflineIndicator.tsx    # Online/offline status indicator
│       └── UpdateNotification.tsx  # App update notification
├── hooks/
│   └── useOfflineStorage.tsx       # IndexedDB wrapper for offline storage
├── pages/
│   └── Offline.tsx                 # Offline fallback page
├── pwa-register.d.ts               # TypeScript declarations for PWA
└── App.tsx                         # PWA components integrated

public/
├── pwa-192x192.png                 # App icon 192x192
├── pwa-512x512.png                 # App icon 512x512
└── manifest.webmanifest            # Auto-generated by vite-plugin-pwa

vite.config.ts                      # PWA configuration
index.html                          # PWA meta tags added
```

## Configuration

### vite.config.ts
```typescript
VitePWA({
  registerType: 'autoUpdate',
  includeAssets: ['favicon.ico', 'apple-touch-icon.png', 'notification.mp3'],
  manifest: {
    name: 'Discovery Atlas',
    short_name: 'Discovery',
    description: 'Discover adventures, complete quests, and explore the world around you',
    theme_color: '#10b981',
    background_color: '#0a0a0a',
    display: 'standalone',
    // ... icons configuration
  },
  workbox: {
    // Runtime caching strategies for different resource types
    runtimeCaching: [...]
  }
})
```

## Usage

### Installing the App

**iOS (Safari):**
1. Open the app in Safari
2. Tap the Share button
3. Tap "Add to Home Screen"
4. Tap "Add"

**Android (Chrome):**
1. Open the app in Chrome
2. Tap the menu (three dots)
3. Tap "Install app" or "Add to Home Screen"
4. Tap "Install"

**Desktop (Chrome/Edge):**
1. Look for the install icon in the address bar
2. Click "Install"
3. Or use our custom install prompt that appears

### Using Offline Features

1. **View Cached Quests**: 
   - Quests you've viewed while online are cached automatically
   - Access them even when offline

2. **Queue Submissions**:
   - Submit quests while offline
   - They'll sync automatically when you're back online

3. **Check Offline Status**:
   - Indicator appears at the top when you go offline
   - Shows "Back online!" when reconnected

### Testing Offline Mode

1. Open DevTools (F12)
2. Go to Network tab
3. Select "Offline" from the throttling dropdown
4. Navigate the app to test offline functionality

## API Reference

### useOfflineStorage Hook

```typescript
const {
  isReady,              // boolean - IndexedDB ready
  cacheQuest,           // (quest: any) => Promise<void>
  getCachedQuest,       // (id: string) => Promise<CachedQuest>
  getAllCachedQuests,   // () => Promise<CachedQuest[]>
  queueSubmission,      // (submission: any) => Promise<void>
  getPendingSubmissions, // () => Promise<PendingSubmission[]>
  markSubmissionSynced, // (id: string) => Promise<void>
  cacheProfile,         // (profile: any) => Promise<void>
  getCachedProfile,     // (id: string) => Promise<CachedProfile>
  clearOldCache,        // (maxAge?: number) => Promise<void>
} = useOfflineStorage();
```

## Browser Support

- ✅ Chrome 90+
- ✅ Edge 90+
- ✅ Firefox 90+
- ✅ Safari 14.5+ (iOS 14.5+)
- ✅ Samsung Internet 14+
- ⚠️ Safari on macOS (limited PWA support)

## Deployment Checklist

- [x] Service worker configured and tested
- [x] Manifest.json generated with correct icons
- [x] App icons created (192x192, 512x512)
- [x] Meta tags added to index.html
- [x] Offline page created
- [x] Install prompt implemented
- [x] Update notification implemented
- [x] Offline indicator implemented
- [x] IndexedDB storage configured
- [x] Cache strategies optimized
- [ ] Test on iOS Safari
- [ ] Test on Android Chrome
- [ ] Test on desktop browsers
- [ ] Test offline functionality
- [ ] Test background sync
- [ ] Test install flow
- [ ] Test update flow
- [ ] Performance audit (Lighthouse)

## Known Limitations

1. **iOS Safari**: 
   - Limited service worker capabilities
   - Install prompt works differently
   - Background sync not supported

2. **Storage**:
   - IndexedDB has storage limits (varies by browser)
   - Cached data auto-clears after 7 days

3. **Sync**:
   - Pending submissions sync on reconnect
   - Manual refresh may be needed in some cases

## Performance

Run Lighthouse audit to check PWA score:
1. Open DevTools (F12)
2. Go to Lighthouse tab
3. Select "Progressive Web App"
4. Click "Generate report"

Target scores:
- PWA: 100
- Performance: 90+
- Accessibility: 90+
- Best Practices: 90+
- SEO: 90+

## Troubleshooting

### Service Worker Not Registering
- Check browser console for errors
- Ensure HTTPS is enabled (required for PWA)
- Clear browser cache and reload

### Install Prompt Not Showing
- Check if already installed
- Check if dismissed recently
- Ensure beforeinstallprompt event is firing

### Offline Mode Not Working
- Check if service worker is active
- Verify cache strategies in DevTools
- Check IndexedDB for stored data

### Updates Not Applying
- Hard reload (Ctrl+Shift+R)
- Unregister service worker in DevTools
- Clear site data and reload

## Future Enhancements

- [ ] Background sync API for automatic submission sync
- [ ] Push notifications for quest updates
- [ ] Periodic background sync for fresh content
- [ ] Share target API for sharing to the app
- [ ] Badge API for unread notifications
- [ ] File handling API for image uploads
- [ ] Shortcuts API for quick actions
- [ ] More granular cache control
- [ ] Offline analytics tracking
- [ ] Better iOS support with capacitor

## References

- [PWA Documentation](https://web.dev/progressive-web-apps/)
- [Workbox Documentation](https://developers.google.com/web/tools/workbox)
- [vite-plugin-pwa](https://vite-pwa-org.netlify.app/)
- [Service Workers](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
- [IndexedDB](https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API)
